import { useState, useEffect, useRef } from 'react';
import { Button } from "/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "/components/ui/card";
import { Input } from "/components/ui/input";
import { Label } from "/components/ui/label";
import { RadioGroup, RadioGroupItem } from "/components/ui/radio-group";

const TrackingDashboard = () => {
  const [userConsent, setUserConsent] = useState(false);
  const [trackingData, setTrackingData] = useState({
    pageViews: 0,
    sessionDuration: 0,
    clicks: 0,
    scrollDepth: 0,
    location: null as string | null,
    deviceInfo: null as { type: string; browser: string; os: string } | null,
  });
  const [analyticsEnabled, setAnalyticsEnabled] = useState(true);
  const [notification, setNotification] = useState('');
  const [userPreferences, setUserPreferences] = useState({
    allowLocation: false,
    allowDeviceInfo: false,
    allowBehavioral: true,
  });

  const sessionStartTime = useRef(Date.now());
  const clickCount = useRef(0);
  const maxScrollDepth = useRef(0);

  const showNotification = (message: string) => {
    setNotification(message);
    setTimeout(() => setNotification(''), 3000);
  };

  const handleConsent = (consent: boolean) => {
    setUserConsent(consent);
    if (consent) {
      showNotification('Analytics tracking enabled with your permission');
      // Initialize tracking
      initializeTracking();
    } else {
      showNotification('Analytics tracking disabled');
      resetTrackingData();
    }
  };

  const initializeTracking = () => {
    if (!userConsent) return;

    // Track page views
    setTrackingData(prev => ({ ...prev, pageViews: prev.pageViews + 1 }));

    // Track session duration
    const durationInterval = setInterval(() => {
      if (userConsent && analyticsEnabled) {
        setTrackingData(prev => ({
          ...prev,
          sessionDuration: Math.floor((Date.now() - sessionStartTime.current) / 1000)
        }));
      }
    }, 1000);

    // Track clicks
    const handleClick = () => {
      if (userConsent && analyticsEnabled && userPreferences.allowBehavioral) {
        clickCount.current += 1;
        setTrackingData(prev => ({ ...prev, clicks: clickCount.current }));
      }
    };

    // Track scroll depth
    const handleScroll = () => {
      if (userConsent && analyticsEnabled && userPreferences.allowBehavioral) {
        const scrollDepth = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
        maxScrollDepth.current = Math.max(maxScrollDepth.current, scrollDepth);
        setTrackingData(prev => ({ ...prev, scrollDepth: Math.round(maxScrollDepth.current) }));
      }
    };

    // Get device info (with permission)
    if (userPreferences.allowDeviceInfo) {
      const deviceInfo = {
        type: /Mobile|iPhone|Android/.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
        browser: navigator.userAgent.match(/(Chrome|Firefox|Safari|Edge)\//)?.[1] || 'Unknown',
        os: navigator.userAgent.match(/(Windows|Mac OS|Linux|Android|iOS)/)?.[1] || 'Unknown'
      };
      setTrackingData(prev => ({ ...prev, deviceInfo }));
    }

    // Get approximate location (with permission)
    if (userPreferences.allowLocation && navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          // For privacy, we'll just show the coordinates without reverse geocoding
          setTrackingData(prev => ({ 
            ...prev, 
            location: `Lat: ${latitude.toFixed(4)}, Long: ${longitude.toFixed(4)}` 
          }));
        },
        () => {
          setTrackingData(prev => ({ ...prev, location: 'Location access denied' }));
        },
        { enableHighAccuracy: false, timeout: 5000 }
      );
    }

    document.addEventListener('click', handleClick);
    document.addEventListener('scroll', handleScroll);

    return () => {
      clearInterval(durationInterval);
      document.removeEventListener('click', handleClick);
      document.removeEventListener('scroll', handleScroll);
    };
  };

  const resetTrackingData = () => {
    setTrackingData({
      pageViews: 0,
      sessionDuration: 0,
      clicks: 0,
      scrollDepth: 0,
      location: null,
      deviceInfo: null,
    });
    sessionStartTime.current = Date.now();
    clickCount.current = 0;
    maxScrollDepth.current = 0;
  };

  const handlePreferencesChange = (pref: keyof typeof userPreferences, value: boolean) => {
    setUserPreferences(prev => ({ ...prev, [pref]: value }));
    showNotification(`Tracking preference updated for ${pref.replace('allow', '')}`);
  };

  useEffect(() => {
    if (userConsent && analyticsEnabled) {
      return initializeTracking();
    }
  }, [userConsent, analyticsEnabled, userPreferences]);

  return (
    <div className="min-h-screen bg-background p-4 md:p-8">
      <div className="max-w-6xl mx-auto">
        {/* Consent Banner */}
        {!userConsent && (
          <Card className="mb-6 bg-primary/10 border-primary/20">
            <CardHeader>
              <CardTitle className="text-primary">Analytics Consent Required</CardTitle>
              <CardDescription>
                We value your privacy. Please review and consent to the tracking features you're comfortable with.
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-2">
                <h4 className="font-medium">What we track (with your permission):</h4>
                <ul className="text-sm text-muted-foreground list-disc list-inside space-y-1">
                  <li>Page views and session duration</li>
                  <li>Click interactions and scroll behavior</li>
                  <li>Device information (browser, operating system)</li>
                  <li>Approximate location (optional)</li>
                </ul>
              </div>
              <div className="flex gap-4">
                <Button onClick={() => handleConsent(true)} variant="default">
                  Accept Analytics
                </Button>
                <Button onClick={() => handleConsent(false)} variant="outline">
                  Decline Analytics
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Notification */}
        {notification && (
          <div className="fixed top-4 right-4 bg-primary text-primary-foreground px-4 py-2 rounded-lg shadow-lg z-50">
            {notification}
          </div>
        )}

        {/* Main Dashboard */}
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {/* Analytics Control Card */}
          <Card>
            <CardHeader>
              <CardTitle>Tracking Controls</CardTitle>
              <CardDescription>Manage your tracking preferences</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <Label htmlFor="analytics-toggle">Analytics Tracking</Label>
                <div className="relative inline-block w-12 h-6">
                  <input
                    type="checkbox"
                    id="analytics-toggle"
                    checked={analyticsEnabled}
                    onChange={(e) => setAnalyticsEnabled(e.target.checked)}
                    className="sr-only"
                  />
                  <div 
                    className={`block w-12 h-6 rounded-full transition-colors ${
                      analyticsEnabled ? 'bg-primary' : 'bg-muted'
                    }`}
                  />
                  <div 
                    className={`absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform ${
                      analyticsEnabled ? 'transform translate-x-6' : ''
                    }`}
                  />
                </div>
              </div>

              <div className="space-y-3">
                <Label>Tracking Preferences</Label>
                <div className="space-y-2">
                  <div className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      id="location-pref"
                      checked={userPreferences.allowLocation}
                      onChange={(e) => handlePreferencesChange('allowLocation', e.target.checked)}
                      className="w-4 h-4"
                    />
                    <Label htmlFor="location-pref" className="text-sm">Allow Location Tracking</Label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      id="device-pref"
                      checked={userPreferences.allowDeviceInfo}
                      onChange={(e) => handlePreferencesChange('allowDeviceInfo', e.target.checked)}
                      className="w-4 h-4"
                    />
                    <Label htmlFor="device-pref" className="text-sm">Allow Device Information</Label>
                  </div>
                  <div className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      id="behavioral-pref"
                      checked={userPreferences.allowBehavioral}
                      onChange={(e) => handlePreferencesChange('allowBehavioral', e.target.checked)}
                      className="w-4 h-4"
                    />
                    <Label htmlFor="behavioral-pref" className="text-sm">Allow Behavioral Tracking</Label>
                  </div>
                </div>
              </div>

              <Button 
                onClick={() => handleConsent(false)} 
                variant="outline" 
                className="w-full"
                disabled={!userConsent}
              >
                Revoke Consent
              </Button>
            </CardContent>
          </Card>

          {/* Stats Cards */}
          <Card>
            <CardHeader>
              <CardTitle>Session Analytics</CardTitle>
              <CardDescription>Current session data</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="text-center p-4 bg-muted rounded-lg">
                  <div className="text-2xl font-bold text-primary">{trackingData.pageViews}</div>
                  <div className="text-sm text-muted-foreground">Page Views</div>
                </div>
                <div className="text-center p-4 bg-muted rounded-lg">
                  <div className="text-2xl font-bold text-primary">
                    {Math.floor(trackingData.sessionDuration / 60)}m {trackingData.sessionDuration % 60}s
                  </div>
                  <div className="text-sm text-muted-foreground">Session Duration</div>
                </div>
                <div className="text-center p-4 bg-muted rounded-lg">
                  <div className="text-2xl font-bold text-primary">{trackingData.clicks}</div>
                  <div className="text-sm text-muted-foreground">Clicks</div>
                </div>
                <div className="text-center p-4 bg-muted rounded-lg">
                  <div className="text-2xl font-bold text-primary">{trackingData.scrollDepth}%</div>
                  <div className="text-sm text-muted-foreground">Scroll Depth</div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Device Info Card */}
          <Card>
            <CardHeader>
              <CardTitle>Device Information</CardTitle>
              <CardDescription>Your device details</CardDescription>
            </CardHeader>
            <CardContent>
              {trackingData.deviceInfo ? (
                <div className="space-y-2">
                  <div>
                    <span className="font-medium">Device Type:</span> {trackingData.deviceInfo.type}
                  </div>
                  <div>
                    <span className="font-medium">Browser:</span> {trackingData.deviceInfo.browser}
                  </div>
                  <div>
                    <span className="font-medium">Operating System:</span> {trackingData.deviceInfo.os}
                  </div>
                </div>
              ) : (
                <div className="text-muted-foreground">Device information tracking disabled</div>
              )}
            </CardContent>
          </Card>

          {/* Location Card */}
          <Card>
            <CardHeader>
              <CardTitle>Location</CardTitle>
              <CardDescription>Approximate location data</CardDescription>
            </CardHeader>
            <CardContent>
              {trackingData.location ? (
                <div className="font-mono text-sm">{trackingData.location}</div>
              ) : (
                <div className="text-muted-foreground">Location tracking disabled or not available</div>
              )}
            </CardContent>
          </Card>

          {/* Privacy Info Card */}
          <Card>
            <CardHeader>
              <CardTitle>Privacy Information</CardTitle>
              <CardDescription>Your privacy rights</CardDescription>
            </CardHeader>
            <CardContent className="space-y-3">
              <p className="text-sm text-muted-foreground">
                You have full control over what data is collected. All tracking requires explicit consent and can be disabled at any time.
              </p>
              <div className="text-xs text-muted-foreground space-y-1">
                <div>• Data is stored locally in your browser</div>
                <div>• No data is shared with third parties</div>
                <div>• You can delete all data by revoking consent</div>
                <div>• Tracking stops immediately when disabled</div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Demo Content */}
        <Card className="mt-6">
          <CardHeader>
            <CardTitle>Interactive Demo Content</CardTitle>
            <CardDescription>Interact with this content to see tracking in action</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="p-6 bg-muted rounded-lg space-y-4">
              <p>This is sample content to demonstrate tracking capabilities. Try clicking buttons and scrolling to see analytics update.</p>
              <div className="flex gap-2">
                <Button variant="outline" size="sm">Sample Button 1</Button>
                <Button variant="outline" size="sm">Sample Button 2</Button>
                <Button variant="outline" size="sm">Sample Button 3</Button>
              </div>
              <div className="h-40 overflow-y-auto bg-background p-4 border rounded">
                <p className="mb-4">Scrollable content area. Scroll down to see scroll depth tracking.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                <p className="mt-4">More content here to make this area scrollable...</p>
                <p>Even more content to ensure scrolling is possible...</p>
                <p>Final content at the bottom of the scrollable area.</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

export default TrackingDashboard;
